const express = require('express');
const router = express.Router();
const Confession = require('../models/Confession');
const confessionController = require('../controllers/confessionController');

// Cr√©er une nouvelle confession
router.post('/confessions', async (req, res) => {
    try {
        const { content } = req.body;
        const newConfession = new Confession({ content });
        await newConfession.save();
        res.status(201).json(newConfession);
    } catch (error) {
        res.status(500).json({ error: 'Erreur lors de la cr√©ation de la confession' });
    }
});

// R√©cup√©rer toutes les confessions
router.get('/confessions', async (req, res) => {
    try {
        const confessions = await Confession.find().sort({ createdAt: -1 });
        res.status(200).json(confessions);
    } catch (error) {
        res.status(500).json({ error: 'Erreur lors de la r√©cup√©ration des confessions' });
    }
});

// R√©agir √† une confession
router.post('/confessions/:id/reactions', async (req, res) => {
    try {
        const { reaction } = req.body;  // Exemple: { reaction: 'üòÇ' }
        const confession = await Confession.findById(req.params.id);

        if (!confession) return res.status(404).json({ error: 'Confession non trouv√©e' });

        // Incr√©menter la r√©action
        confession.reactions.set(reaction, (confession.reactions.get(reaction) || 0) + 1);
        await confession.save();

        res.status(200).json(confession);
    } catch (error) {
        res.status(500).json({ error: 'Erreur lors de l\'ajout de la r√©action' });
    }
});

// Ajouter une r√©ponse anonyme
router.post('/confessions/:id/replies', async (req, res) => {
    try {
        const { content } = req.body;
        const confession = await Confession.findById(req.params.id);

        if (!confession) return res.status(404).json({ error: 'Confession non trouv√©e' });

        confession.replies.push({ content });
        await confession.save();

        res.status(200).json(confession);
    } catch (error) {
        res.status(500).json({ error: 'Erreur lors de l\'ajout de la r√©ponse' });
    }
});

// Route pour ajouter une r√©ponse √† une confession
router.post('/confessions/:confessionId/replies', confessionController.addReply);

// Route pour ajouter une sous-r√©ponse √† une r√©ponse sp√©cifique d'une confession
router.post('/confessions/:confessionId/replies/:replyId', confessionController.addSubReply);

module.exports = router;
